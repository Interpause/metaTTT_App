!function(){var e={locked:"BOARD LOCKED",occupied:"SQUARE FULL",started:"GAME STARTED",full:"GAME FULL",move:"MOVE",turn:"TURN",okay:"OKAY",error:"FAIL",null:"NullPointerException",info:"INFO",busy:"BUSY",getSessions:"GET SESSIONS",getSpecSessions:"GET SPEC SESSIONS",findSession:"FIND ME A GAME",updateState:"STATE UPDATE",join:"JOIN",leave:"LEAVE",connect:"HELLO"},t={grid_len:3,num_players:2,win_req:3,size:9,checks:{horiz:[1,0],verti:[0,1],rdiag:[1,1],ldiag:[-1,1]}},n=class{get cur_player(){return this.player_ids[this.cur_player_ind]}constructor(e,n){if(this.config=t,this.history=[],this.player_ids=[],this.grid={},this.turns=0,this.winner=null,this.cur_board=null,this.cur_player_ind=0,n)return this.config=e.config,this.history=e.history,this.player_ids=e.player_ids,this.grid=e.grid,this.turns=e.turns,this.winner=e.winner,this.cur_board=e.cur_board,void(this.cur_player_ind=e.cur_player_ind);e&&(this.config=e),this.config.size=this.config.grid_len**2,this.grid={winner:null},this.history.push(this.config);for(let t=1;t<=this.config.size;t++){let e={winner:null};for(let t=1;t<=this.config.size;t++)e[t]={winner:null};this.grid[t]=e}}place(e){this.checkMoveValid(e),this.grid[e[0]][e[1]].winner=this.cur_player_ind,this.history.push([this.cur_player,e]),this.updateWins(e[0]),null!=this.grid[e[1]].winner?this.cur_board=null:this.cur_board=e[1],this.turns++,this.cur_player_ind=this.turns%this.config.num_players}updateWins(e){if(null!=this.winner)return;let t=this.checkWin(this.grid[e]);if(-1==t)this.grid[e].winner=-1;else if(1==t){this.grid[e].winner=this.cur_player_ind;let t=this.checkWin(this.grid);-1==t?(this.grid.winner=-1,this.winner=-1):1==t&&(this.grid.winner=this.cur_player_ind,this.winner=this.cur_player_ind)}}checkWin(e){let t=!0;for(let n=1;n<=this.config.size;n++)for(let i in this.config.checks){let r=!0,s=this.oD2D(n);for(let o=1;r&&o<this.config.win_req;o++){if(null==e[n].winner){r=!1,t=!1;break}let l={x:s.x+o*this.config.checks[i][0],y:s.y+o*this.config.checks[i][1]};if(l.y>=this.config.grid_len|l.x>=this.config.grid_len|l.y<0|l.x<0){r=!1;break}if(e[this.tD1D(l)].winner!=e[n].winner){r=!1;break}}if(r)return 1}return t?-1:0}checkMoveValid(t){if(null!=this.winner)throw new Error(e.error);if(null!=this.cur_board&&this.cur_board!=t[0])throw new Error(`${e.locked}: ${t[0]},${t[1]}`);if(null!=this.grid[t[0]][t[1]].winner)throw new Error(`${e.occupied}: ${t[0]},${t[1]}`)}oD2D(e){return{x:(e-1)%this.config.grid_len,y:Math.floor((e-1)/this.config.grid_len)}}tD1D(e){return e.y*this.config.grid_len+e.x+1}},r={},s=Object.create||function(e){var t=function(){};return t.prototype=e,new t},o=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return n},l=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function a(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=s(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}r=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._maxListeners=void 0;var c,d=10;try{var u={};Object.defineProperty&&Object.defineProperty(u,"x",{value:0}),c=0===u.x}catch(x){c=!1}function w(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function g(e,t,n,i){var r,o,l;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((o=e._events)?(o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),l=o[t]):(o=e._events=s(null),e._eventsCount=0),l){if("function"==typeof l?l=o[t]=i?[n,l]:[l,n]:i?l.unshift(n):l.push(n),!l.warned&&(r=w(e))&&r>0&&l.length>r){l.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+l.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=l.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",a.name,a.message)}}else l=o[t]=n,++e._eventsCount;return e}function h(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function p(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=l.call(h,i);return r.listener=n,i.wrapFn=r,r}function y(e,t,n){var i=e._events;if(!i)return[];var r=i[t];return r?"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):m(r,r.length):[]}function f(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function m(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}c?Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');d=e}}):a.defaultMaxListeners=d,a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return w(this)},a.prototype.emit=function(e){var t,n,i,r,s,o,l="error"===e;if(o=this._events)l=l&&null==o.error;else if(!l)return!1;if(l){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var a=new Error('Unhandled "error" event. ('+t+")");throw a.context=t,a}if(!(n=o[e]))return!1;var c="function"==typeof n;switch(i=arguments.length){case 1:!function(e,t,n){if(t)e.call(n);else for(var i=e.length,r=m(e,i),s=0;s<i;++s)r[s].call(n)}(n,c,this);break;case 2:!function(e,t,n,i){if(t)e.call(n,i);else for(var r=e.length,s=m(e,r),o=0;o<r;++o)s[o].call(n,i)}(n,c,this,arguments[1]);break;case 3:!function(e,t,n,i,r){if(t)e.call(n,i,r);else for(var s=e.length,o=m(e,s),l=0;l<s;++l)o[l].call(n,i,r)}(n,c,this,arguments[1],arguments[2]);break;case 4:!function(e,t,n,i,r,s){if(t)e.call(n,i,r,s);else for(var o=e.length,l=m(e,o),a=0;a<o;++a)l[a].call(n,i,r,s)}(n,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(r=new Array(i-1),s=1;s<i;s++)r[s-1]=arguments[s];!function(e,t,n,i){if(t)e.apply(n,i);else for(var r=e.length,s=m(e,r),o=0;o<r;++o)s[o].apply(n,i)}(n,c,this,r)}return!0},a.prototype.addListener=function(e,t){return g(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return g(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,p(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,p(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,i,r,o,l;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=s(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){l=n[o].listener,r=o;break}if(r<0)return this;0===r?n.shift():function(e,t){for(var n=r,i=n+1,s=e.length;i<s;n+=1,i+=1)e[n]=e[i];e.pop()}(n),1===n.length&&(i[e]=n[0]),i.removeListener&&this.emit("removeListener",e,l||t)}return this},a.prototype.removeAllListeners=function(e){var t,n,i;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=s(null),this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=s(null):delete n[e]),this;if(0===arguments.length){var r,l=o(n);for(i=0;i<l.length;++i)"removeListener"!==(r=l[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=s(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},a.prototype.listeners=function(e){return y(this,e,!0)},a.prototype.rawListeners=function(e){return y(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},a.prototype.listenerCount=f,a.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var v=class extends r{constructor(e){super(),this.state={},this.isStarted=!1,this.num_players=0,this.max_players=0,this.num_spectators=0,this.gconfig=t,this.online=null==e,this.gui=e,this.player_ids=[],this.spectators=[]}init(e){e&&(this.gconfig=e),this.max_players=this.gconfig.num_players,this.state=new n(this.gconfig)}restoreSession(e){this.gconfig=e.config,this.max_players=this.gconfig.num_players,this.num_players=this.max_players,this.player_ids=e.player_ids.slice(),this.spectators=e.player_ids.slice(),this.state=new n(e,!0)}addPlayer(t){if(this.isStarted)throw new Error(e.started);if(this.max_players==this.num_players)throw new Error(e.full);this.player_ids.push(t),this.addSpectator(t),this.num_players++}addSpectator(e){this.spectators.push(e),this.num_spectators++}removeSpectator(e){let t=this.spectators.indexOf(e);t>-1&&(this.spectators.splice(t,1),this.num_spectators--)}getState(t){if(this.spectators.indexOf(t)>-1)return this.state;throw new Error(e.locked)}getInfo(){return{started:this.isStarted,numPlys:this.num_players,maxPlys:this.max_players,gconf:this.gconfig,plyrs:this.player_ids,specs:this.spectators,turn:this.state.turns,cur:this.state.cur_player_ind}}setInput(t,n){if(this.state.cur_player!=t)throw new Error(e.locked);this.state.place(n)}start(){if(this.isStarted)throw new Error(e.started);if(this.isStarted=!0,this.num_players!=this.max_players)throw new Error(e.error);this.state.player_ids=this.player_ids,this.online||(this.gui.receivePlayersInfo(this.player_ids),this.gui.receiveBoard(this.state))}};(function(e){(function(){let t=null;try{t=window}catch(n){}try{t=e}catch(n){}t.gen_uuid=(e=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))),t.wait=(e=>new Promise((t,n)=>setTimeout(t,e)))}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{}),window.gconf=t,window.game=null,window.startLocalGame=async function(){window.displayLoadingIndicator(),await window.gui.init(window.guiConfig,window.gconf,!1);let e=new v(window.gui);e.init(window.gconf);for(let t=0;t<window.gconf.num_players;t++)e.addPlayer(window.client.pid);e.start(),window.game=e,window.hideLoadingIndicator()},window.loadGame=async function(e,t){if(window.displayLoadingIndicator(),await window.gui.init(window.guiConfig,e.config,t),t){let t=new n(e,!0);t.names=e.names,window.gui.receivePlayersInfo(t.player_ids),window.gui.receiveBoard(t)}else{let t=new v(window.gui);t.restoreSession(e),t.start(),window.game=t}window.hideLoadingIndicator()};let S={initialize:function(){document.addEventListener("deviceready",this.onDeviceReady.bind(this),!1)},onDeviceReady:function(){document.addEventListener("backbutton",this.onBackKey.bind(this),!1),document.addEventListener("resume",this.onAppResume.bind(this),!1),document.addEventListener("pause",this.onAppPause.bind(this),!1),window.screen.orientation.lock("portrait-primary"),window.StatusBar.hide(),this.receivedEvent("deviceready")},onAppPause:function(){document.querySelector("#bgMusic").pause(),-1==window.game.state.winner?window.localStorage.setItem("save",JSON.stringify(window.game.state)):window.localStorage.removeItem("save")},onAppResume:function(){document.querySelector("#bgMusic").play()},onBackKey:function(){window.btnBack()},receivedEvent:async function(e){if("deviceready"!=e)return;window.changeFocus(window.guiState.gamePg),window.guiConfig.cont.style.opacity=1;let t=window.localStorage.getItem("settings");if(null!=t){let e=JSON.parse(t);""!=e.client_url&&(window.client.url=e.client_url),window.client.name=e.client_name,e.performance_mode||window.generateBg()}else window.generateBg();let n=window.localStorage.getItem("clientid");null==n&&(n=gen_uuid());let i=window.localStorage.getItem("passwd");null==i&&(i=gen_uuid()),window.client.pid=n,window.client.passwd=i,window.localStorage.setItem("clientid",window.client.pid),window.localStorage.setItem("passwd",window.client.passwd);let r=window.localStorage.getItem("save");if(null==r)await window.startLocalGame();else try{await window.loadGame(JSON.parse(r),!1)}catch(s){console.log(s),await window.startLocalGame()}"browser"==cordova.platformId&&document.querySelector(".app").classList.add("browser"),document.querySelector("#splash").style.display="none"}};window.app=S,S.initialize();var _={};const b={rows:10,cols:4,min_speed:20,max_speed:50,gap_ratio:.15,randomness:.75},P=50*1.732050808;function L(e,t,n){let i={},r=function(e,t,n){let i=n.colors.slice(),r=[];Math.random()<n.randomness&&null!=e&&i.splice(i.indexOf(e),1),Math.random()<n.randomness&&null!=t&&i.splice(i.indexOf(t),1),r.push(i[Math.floor(Math.random()*i.length)]);let s=n.colors.slice();s.splice(s.indexOf(r[0]),1);for(let o=s.length-1;o>0;o--){let e=Math.floor(Math.random()*(o+1));[s[o],s[e]]=[s[e],s[o]]}return r.concat(s)}(e,t,n);return r.push(r.slice(0,1)[0]),i.color_seq=r,i.speed=Math.floor(Math.random()*(n.max_speed-n.min_speed))+n.min_speed,i}b.colors=["#ffffff","#0c7c5f","#000000","#fab20b","#e62840","#8862b8","#fddb0d","#deddde","#ffffff","#0c7c5f","#000000"],_.genBg=function(e){let t=Object.assign({},b);null!=e&&Object.entries(e).forEach(([e,n])=>t[e]=n);let n=50*t.gap_ratio,i=n/2,r=n/2*.866025404,s=100*t.cols,o=P*t.rows+r/4,l=document.createElementNS("http://www.w3.org/2000/svg","svg");l.setAttribute("xmlns","http://www.w3.org/2000/svg"),l.setAttribute("viewBox",`0 0 ${s} ${o}`),l.setAttribute("shape-rendering","geometricPrecision");let a=document.createElementNS("http://www.w3.org/2000/svg","g");l.appendChild(a);let c=[],d=[],u=void 0,w=!1;for(let g=0;g<2*t.rows;g++){w=g%2==0;let e=document.createElementNS("http://www.w3.org/2000/svg","polygon"),o=document.createElementNS("http://www.w3.org/2000/svg","polygon"),l=L(c[0],u,t);e.setAttribute("fill",l.color_seq[0]),o.setAttribute("fill",l.color_seq[0]),d.push(l.color_seq[0]),u=l.color_seq[0];let h=0,p=g*P+(w?r:n)/2,y=0,f=(g+1)*P-(w?n:r)/2,m=50-i,v=w?g*P+r/2:(g+1)*P-r/2,S=s,_=p,b=s,k=f,q=s-50+i,E=v;e.setAttribute("points",`${h},${p} ${y},${f} ${m},${v}`),o.setAttribute("points",`${S},${_} ${b},${k} ${q},${E}`),e.setAttribute("shape-rendering","geometricPrecision"),o.setAttribute("shape-rendering","geometricPrecision");let I=document.createElementNS("http://www.w3.org/2000/svg","animate");I.setAttribute("attributeName","fill"),I.setAttribute("values",`${l.color_seq.join(";")};`),I.setAttribute("dur",`${l.speed}s`),I.setAttribute("repeatCount","indefinite"),e.appendChild(I.cloneNode(!0)),o.appendChild(I.cloneNode(!0)),a.appendChild(e),a.appendChild(o);for(let s=1;s<2*t.cols;s++){let e=document.createElementNS("http://www.w3.org/2000/svg","polygon"),o=L(c[s],u,t);e.setAttribute("fill",o.color_seq[0]),d.push(o.color_seq[0]),u=o.color_seq[0];let l=100*(s-1)/2+i,h=w?(g+1)*P-r/2:g*P+r/2,p=100*(s+1)/2-i,y=w?(g+1)*P-r/2:g*P+r/2,f=100*s/2,m=w?g*P+n/2:(g+1)*P-n/2;e.setAttribute("points",`${l},${h} ${p},${y} ${f},${m}`),e.setAttribute("shape-rendering","geometricPrecision");let v=document.createElementNS("http://www.w3.org/2000/svg","animate");v.setAttribute("attributeName","fill"),v.setAttribute("values",`${o.color_seq.join(";")};`),v.setAttribute("dur",`${o.speed}s`),v.setAttribute("repeatCount","indefinite"),e.appendChild(v),a.appendChild(e),w=!w}u=void 0,c=d,d=[]}return l};let k={gamePg:document.querySelector("#gamePg"),settingsPg:document.querySelector("#settingsPg"),creditsPg:document.querySelector("#creditsPg"),onlinePg:document.querySelector("#onlinePg"),onlineGamePg:document.querySelector("#onlineGamePg"),spectatePg:document.querySelector("#spectatePg"),sessBars:Array.from(document.querySelectorAll("#onlinePg .sessionInfo")),specBars:Array.from(document.querySelectorAll("#spectatePg .sessionInfo")),header:document.querySelector("#onlineGameHeader"),forfeitBtn:document.querySelector("#endSession"),loadIndicator:document.querySelector("#loadingIndicator"),noInternetIndicator:document.querySelector("#weakInternetIndicator"),clickSnd:document.querySelector("#clkSnd"),rstSnd:document.querySelector("#clkSnd"),tadaSnd:document.querySelector("#tadaSnd"),pgFocus:null,backSeq:[document.querySelector("#gamePg")],pgTransitionInProg:!1,btnReplayInProg:!1};window.guiState=k,k.gamePg.arrive=(async()=>window.client.disconnect()),k.settingsPg.arrive=(async()=>{let e=window.localStorage.getItem("settings");if(null!=e){let t=JSON.parse(e),n=document.querySelector("#settingsCont");n.querySelector("input[name='client_url']").value=t.client_url,n.querySelector("input[name='client_name']").value=t.client_name,n.querySelector("input[name='performance_mode']").checked=t.performance_mode}}),k.creditsPg.arrive=(async()=>{}),k.onlinePg.arrive=(async()=>window.client.connect().then(()=>window.client.getSavedSessions())),k.onlineGamePg.arrive=(async()=>window.onlineGrid()),k.spectatePg.arrive=(async()=>window.client.getSpecSessions()),k.gamePg.leave=(async()=>{}),k.settingsPg.leave=(async()=>{}),k.creditsPg.leave=(async()=>{}),k.onlinePg.leave=(async()=>{}),k.onlineGamePg.leave=(async()=>{null!=window.gui.state.names&&1==window.gui.state.names.length&&window.client.quitSession(),window.client.online=!1,window.client.gid=null,window.resetGrid()}),k.spectatePg.leave=(async()=>{}),document.querySelector("#endSession").addEventListener("click",()=>window.client.quitSession()),document.querySelector("#sobtn2").addEventListener("click",()=>window.client.getSpecSessions()),window.changeFocus=async function(e){null!=k.pgFocus&&await k.pgFocus.leave(),await e.arrive(),k.pgFocus=e},window.switchPg=async function(t){if(k.pgTransitionInProg)throw new Error(e.busy);k.pgTransitionInProg=!0;try{await window.changeFocus(t)}catch(r){throw k.pgTransitionInProg=!1,r}t.style.setProperty("display","block"),await wait(70);let n=k.backSeq[k.backSeq.length-1];k.backSeq.length>1&&n.classList.remove("pgFocus");let i="translate(0vw,0vh)";t.classList.contains("pgLeft")&&(i="translateX(100vw)"),t.classList.contains("pgRight")&&(i="translateX(-100vw)"),t.classList.contains("pgTop")&&(i="translateY(100vh)"),t.classList.contains("pgBtm")&&(i="translateY(-100vh)"),n.style.setProperty("transform",i),t.classList.add("pgFocus"),wait(300).then(()=>{n.style.setProperty("display","none"),k.backSeq.push(t),k.pgTransitionInProg=!1})},window.btnBack=async function(){if(k.pgTransitionInProg)throw new Error(e.busy);if(k.clickSnd.play(),k.backSeq.length<2)throw new Error(e.error);k.pgTransitionInProg=!0;let t=k.backSeq[k.backSeq.length-1],n=k.backSeq[k.backSeq.length-2];try{await window.changeFocus(n)}catch(i){throw k.pgTransitionInProg=!1,i}n.style.setProperty("display","block"),await wait(70),k.backSeq.length>2&&n.classList.add("pgFocus"),t.classList.remove("pgFocus"),n.style.setProperty("transform",null),wait(300).then(()=>{t.style.cssText=null,k.backSeq.pop(),k.pgTransitionInProg=!1},300)};for(let i of document.querySelectorAll(".backBtn"))i.addEventListener("click",()=>window.btnBack());window.btnGamePg=function(e){if(k.clickSnd.play(),k.pgFocus==k.gamePg)switch(e){case"settings":window.switchPg(k.settingsPg);break;case"share":break;case"credits":window.switchPg(k.creditsPg);break;case"feedback":window.LaunchReview.launch();break;case"multiplayer":window.switchPg(k.onlinePg);break;case"puzzle":case"shop":break;case"replay":window.resetGrid()}},document.querySelector("#mbtn1").addEventListener("click",()=>window.btnGamePg("settings")),document.querySelector("#mbtn2").addEventListener("click",()=>window.btnGamePg("share")),document.querySelector("#mbtn3").addEventListener("click",()=>window.btnGamePg("credits")),document.querySelector("#mbtn4").addEventListener("click",()=>window.btnGamePg("feedback")),document.querySelector("#mbtn5").addEventListener("click",()=>window.btnGamePg("multiplayer")),document.querySelector("#mbtn6").addEventListener("click",()=>window.btnGamePg("puzzle")),document.querySelector("#mbtn7").addEventListener("click",()=>window.btnGamePg("shop")),document.querySelector("#mbtn8").addEventListener("click",()=>window.btnGamePg("replay")),window.saveSettings=function(){let e=document.querySelector("#settingsCont"),t=e.querySelector("input[name='grid_len']:checked").value,n=e.querySelector("input[name='plyr_no']:checked").value,i=e.querySelector("input[name='win_req']:checked").value,r=!1;t!=window.gconf.grid_len&&(window.gconf.grid_len=t,r=!0),n!=window.gconf.num_players&&(window.gconf.num_players=n,r=!0),i!=window.gconf.win_req&&(window.gconf.win_req=i,r=!0),r&&window.resetGrid();let s=e.querySelector("input[name='client_url']").value;window.client.url=""==s?window.client.url:s;let o=e.querySelector("input[name='client_name']").value;window.client.name=""==o?window.client.name:o;let l=e.querySelector("input[name='performance_mode']"),a=document.querySelector("#bg");if(l.checked)for(;a.hasChildNodes();)a.removeChild(a.lastChild);else a.hasChildNodes()||window.generateBg();let c={client_url:s,client_name:window.client.name,performance_mode:l.checked};window.localStorage.setItem("settings",JSON.stringify(c)),window.btnBack()},document.querySelector("#sbtn1").addEventListener("click",()=>window.saveSettings()),window.btnOnlinePg=function(e){if(k.clickSnd.play(),k.pgFocus==k.onlinePg)switch(e){case"quickPlay":window.client.findSession().then(()=>window.switchPg(k.onlineGamePg));break;case"spectateMenu":window.switchPg(k.spectatePg);break;case"refreshPg":window.client.getSavedSessions()}},document.querySelector("#obtn2").addEventListener("click",()=>window.btnOnlinePg("spectateMenu")),document.querySelector("#obtn3").addEventListener("click",()=>window.btnOnlinePg("refreshPg")),document.querySelector("#obtn4").addEventListener("click",()=>window.btnOnlinePg("quickPlay")),window.genSessMenu=function(e,t){let n=1==t?k.specBars:k.sessBars;n.forEach(e=>e.style.display="none");let i=0;for(let r in e){let t=n[i],s=e[r];if(null==t)return void console.log("More save states sent from server than bars?");s.plyrs[s.cur]==window.client.pid?t.querySelectorAll(".sessInfo")[0].innerHTML=`Your Turn @ ${s.turn} moves`:t.querySelectorAll(".sessInfo")[0].innerHTML=s.names[s.cur]+`'s Turn @ ${s.turn} moves`,t.querySelectorAll(".mini")[0].onclick=(()=>{window.client.gid=r,window.switchPg(k.onlineGamePg)}),t.setAttribute("gid",r),t.style.display="block",i++}},window.hideGrid=async function(){k.rstSnd.play();let e=window.guiConfig.cont;if(0!=e.style.opacity)return Array.from(document.querySelectorAll(".btn")).forEach(e=>e.style.setProperty("animation",null)),e.style="",e.style.setProperty("transition","transform 1.2s, opacity 0.4s linear, color 0.5s ease 0.1s"),e.style.setProperty("transform","rotate(-1440deg)"),e.style.setProperty("opacity","0"),wait(400)},window.showGrid=async function(){let e=window.guiConfig.cont;1!=e.style.opacity&&(e.style.setProperty("opacity","1"),await wait(800),e.style.setProperty("transition","color 0.5s ease 0.1s"),e.style.setProperty("transform",null))},window.resetGrid=async function(){if(k.btnReplayInProg)throw new Error(e.busy);k.btnReplayInProg=!0,await window.hideGrid(),window.gui.state={},window.guiConfig.cont=document.querySelector("#gamePg .TTTgame"),await window.startLocalGame(),await window.showGrid(),k.btnReplayInProg=!1},window.onlineGrid=async function(){window.guiConfig.cont=document.querySelector("#onlineGamePg .TTTgame"),window.gui.state={},k.header.innerHTML="Waiting...";let e=[window.hideGrid(),window.client.joinSession()];return await Promise.all(e),window.showGrid()},window.updateHeader=function(){if(!window.client.online)return;let e=window.gui.state;e.player_ids.length<e.config.num_players?k.header.innerHTML="Waiting...":e.cur_player==window.client.pid?k.header.innerHTML=`Your Turn @ ${e.turns} moves`:k.header.innerHTML=e.names[e.cur_player_ind]+`'s Turn @ ${e.turns} moves`},window.menuWinAnim=function(){k.tadaSnd.play(),Array.from(document.querySelectorAll(".btn")).forEach(e=>e.style.setProperty("animation","winBtn 0.5s linear 0s infinite"))},window.weakInternetAnim=function(){k.noInternetIndicator.style.opacity=1,wait(1e3).then(()=>k.noInternetIndicator.style.opacity=0)},window.displayLoadingIndicator=function(){document.querySelector("#loadingIndicator").style.opacity=1},window.hideLoadingIndicator=function(){document.querySelector("#loadingIndicator").style.opacity=0},window.generateBg=function(){let e=_.genBg();e.style.width="100%",e.style.height="auto",document.querySelector("#bg").appendChild(e)};let q={};window.guiConfig=q,q.cont=document.querySelector("#gamePg .TTTgame"),q.grid_pfx="grid",q.sqr_pfx="btn",window.musicPlaying=!1,window.onclick=function(){window.musicPlaying||document.querySelector("#bgMusic").play(),window.musicPlaying=!0};let E={guiconf:{},gconf:{},input:null,state:{},players:[],hist:[],online:!1,btnList:[],olyList:[],isProc:!1,prevMove:null};window.gui=E,E.init=async function(t,n,i){this.guiconf=t,this.gconf=n,this.online=i,this.guiconf.plyColors=[],this.btnList=[],this.olyList=[],this.prevMove=null,this.hist.push([e.info,"ONLINE",this.online]),this.guiconf.cont.innerHTML="";for(let e=1;e<=this.gconf.grid_len;e++)for(let t=1;t<=this.gconf.grid_len;t++){let n=document.createElement("div");n.style.setProperty("grid-column",`${t} / span 1`),n.style.setProperty("grid-row",`${e} / span 1`),n.classList.add("grid");let i=document.createElement("div");i.style.setProperty("grid-column",`1 / span ${this.gconf.grid_len}`),i.style.setProperty("grid-row",`1 / span ${this.gconf.grid_len}`),i.classList.add("gridOly"),n.appendChild(i),this.olyList.push(i);for(let r=1;r<=this.gconf.grid_len;r++)for(let i=1;i<=this.gconf.grid_len;i++){let s=document.createElement("button");s.style.setProperty("grid-column",`${i} / span 1`),s.style.setProperty("grid-row",`${r} / span 1`),s.setAttribute(this.guiconf.grid_pfx,(e-1)*this.gconf.grid_len+t),s.setAttribute(this.guiconf.sqr_pfx,(r-1)*this.gconf.grid_len+i),s.addEventListener("click",this.btn_link),s.disabled=!0,s.classList.add("sqr"),n.appendChild(s),this.btnList.push(s)}this.guiconf.cont.appendChild(n)}},E.receivePlayersInfo=function(e){this.players=e,this.guiconf.plyColors=[];for(let t=0;t<this.players.length;t++)this.guiconf.plyColors.push(`hsl(${t*(360/this.players.length)%360},100%,50%)`)},E.receiveBoard=async function(t){return this.state=t,this.hist.push([e.turn,this.state.cur_player_ind]),window.updateHeader(),this.updateContainer()},E.receiveHist=function(e){for(let t of e)this.hist.push(t)},E.getHistLen=function(){return this.hist.length},E.getPrevMove=function(){let e=E.state.history;if(!e||0==e.length)return null;for(i=e.length-1;i>=0;i--){let t=e[i];if(Array.isArray(t)&&2==t.length&&"string"==typeof t[0])return t[1]}return null},E.updateContainer=async function(){for(let s of E.btnList)s.disabled=!0;let e=E.prevMove,t=E.getPrevMove(),n=!1;null==e&&null==t?n=!1:null==e&&null!=t?n=!0:null==t&&null!=e?n=!0:e[0]!=t[0]?n=!0:e[1]!=t[1]&&(n=!0),E.prevMove=t;let i=null,r=null;for(let s=0;s<E.btnList.length;s++){let o=E.btnList[s],l=o.getAttribute(E.guiconf.grid_pfx),a=o.getAttribute(E.guiconf.sqr_pfx),c=!1;null!=E.state.grid[l].winner?c=!0:null!=E.state.grid[l][a].winner?c=!0:null!=E.state.cur_board&&E.state.cur_board!=l?c=!1:E.state.cur_player!=window.client.pid?c=!1:o.disabled=!1,c&&(o.style.setProperty("z-index","3"),-1!=E.state.grid[l].winner&&null!=E.state.grid[l].winner?(o.style.setProperty("transition","background-color 0.5s ease-in 0s"),o.style.setProperty("background-color",E.guiconf.plyColors[E.state.grid[l].winner],"important")):(o.style.setProperty("transition","background-color 0s"),o.style.setProperty("background-color",E.guiconf.plyColors[E.state.grid[l][a].winner],"important"))),n&&null!=e&&e[0]==l&&e[1]==a&&(i=o),n&&null!=t&&t[0]==l&&t[1]==a&&(r=o)}null!=i&&(i.style.setProperty("outline","none"),i.style.setProperty("outline-offset","0px")),null!=r&&(r.style.setProperty("outline","solid 2px yellow"),r.style.setProperty("outline-offset","-2px"));for(let s=1;s<=E.olyList.length;s++){let e=!1,t=E.olyList[s-1];(e=E.state.player_ids.length<E.state.config.num_players||E.state.cur_player!=window.client.pid||!(null==E.state.cur_board|E.state.cur_board==s))?(t.style.setProperty("transition","opacity 0.2s ease-in 0s"),t.style.setProperty("opacity","0.6")):(t.style.setProperty("transition","opacity 0s"),t.style.setProperty("opacity","0"))}E.guiconf.cont.style.setProperty("color",E.guiconf.plyColors[E.state.cur_player_ind]),null!=E.state.winner&&(null!=i&&(i.style.setProperty("outline","none"),i.style.setProperty("outline-offset","0px")),null!=r&&(r.style.setProperty("outline","none"),r.style.setProperty("outline-offset","0px")),E.gridWinAnim(),window.menuWinAnim())},E.gridWinAnim=function(){this.btnList.forEach(e=>{e.disabled=!0,e.style.setProperty("transition","background-color 0.5s ease-in 0s"),wait(200).then(()=>{e.style.setProperty("z-index","3"),e.style.setProperty("background-color",this.guiconf.plyColors[this.state.winner],"important")})}),this.guiconf.cont.style.setProperty("animation","winGlow 3s linear 0s infinite")},E.btn_link=function(t){if(E.isProc)return;E.isProc=!0;let n=t.target;if(n.disabled)return;let i=[n.getAttribute(E.guiconf.grid_pfx),n.getAttribute(E.guiconf.sqr_pfx)];E.online?(E.guiconf.cont.style.setProperty("color","white"),window.client.makeMove(i)):(E.guiconf.cont.style.setProperty("color","white"),E.state.place(i),E.updateContainer(),E.hist.push([e.move,i])),E.isProc=!1};const I=(e,t)=>new Promise(n=>e.once(t,()=>n()));let A=Object.assign(new r,{name:"Guest",gid:null,pid:null,passwd:null,online:!1,ws:null,url:"wss://metattt-server.glitch.me"});window.client=A,A.connect_ws=function(){return new Promise((e,t)=>{let n=new WebSocket(this.url);n.onopen=(()=>e(n)),n.onerror=(e=>t(e))})},A.connect=async function(){if(!this.ws||1!=this.ws.readyState){this.online=!1,console.log("connecting..."),window.displayLoadingIndicator();try{this.ws=await this.connect_ws()}catch(t){throw window.hideLoadingIndicator(),window.weakInternetAnim(),t}return this.ws.onerror=(e=>{3==this.ws.readyState&&(window.hideLoadingIndicator(),window.weakInternetAnim()),console.error(e)}),this.ws.onclose=(e=>{this.online&&(window.weakInternetAnim(),console.log(e),console.log("reconnecting..."),this.connect())}),this.ws.onmessage=(e=>{this.online=!0;let t=JSON.parse(e.data);Array.isArray(t)||(t=[t]),t.forEach(e=>{this.emit(e.event,e.data),console.log("Server: ",e)})}),await I(this,e.connect),this.sendServer(e.connect,{pid:this.pid,passwd:this.passwd,name:this.name}),I(this,e.okay)}},A.disconnect=function(e){this.online=!1,console.log("disconnected existing socket"),null!=this.ws&&(this.ws.close(),this.ws=null,window.hideLoadingIndicator())},A.sendServer=async function(e,t){await this.connect(),console.log("Client: ",{event:e,data:t}),this.ws.send(JSON.stringify({event:e,data:t}))},A.updateState=async function(t){if(null==t)throw new Error(`${e.null}: Null state`);if(t==e.error)throw new Error(`${e.error}: error state received`);return this.gid=t.gid,t.player_ids.indexOf(this.pid)>-1?window.guiState.forfeitBtn.disabled=!1:window.guiState.forfeitBtn.disabled=!0,window.loadGame(t,!0)},A.getSavedSessions=async function(){window.displayLoadingIndicator(),this.sendServer(e.getSessions),await I(this,e.getSessions),window.hideLoadingIndicator()},A.getSpecSessions=async function(){window.displayLoadingIndicator(),this.sendServer(e.getSpecSessions),await I(this,e.getSpecSessions),window.hideLoadingIndicator()},A.findSession=async function(){window.displayLoadingIndicator(),this.sendServer(e.findSession),await I(this,e.findSession),window.hideLoadingIndicator()},A.joinSession=async function(t){window.displayLoadingIndicator(),null==t&&(t=this.gid),this.sendServer(e.join,{gid:t}),await I(this,e.join),await I(this,e.updateState),window.hideLoadingIndicator()},A.quitSession=async function(){return this.sendServer(e.leave,{gid:this.gid}),window.btnBack(),I(this,e.leave)},A.makeMove=async function(t){window.displayLoadingIndicator(),this.sendServer(e.move,{gid:this.gid,move:t}),await I(this,e.move),window.hideLoadingIndicator()},A.on(e.getSessions,e=>window.genSessMenu(e,!1)),A.on(e.getSpecSessions,e=>window.genSessMenu(e,!0)),A.on(e.findSession,e=>A.gid=e),A.on(e.updateState,A.updateState)}();